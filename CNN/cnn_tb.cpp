#include "hls_stream.h"
#include "ap_axi_sdata.h"
#include <iostream>
#include "cnn.h"
#include <iomanip>

using namespace std;

// Define the same data types as in the matrix_mult function
typedef ap_axiu<32, 0, 0, 0> AXI_VAL;

// Prototype of the matrix multiplication function (from your HLS code)
void cnn(hls::stream<AXI_VAL> &image_in, hls::stream<AXI_VAL> &predict_class);

// Test bench to validate matrix multiplication
int main() {
    // Declare AXI streams
    hls::stream<AXI_VAL> image_in, predict_class;
    float image[img_h][img_w][img_d] = {
    	    {{80, 78, 75}, {78, 76, 74}, {83, 86, 85}, {85, 93, 105}, {110, 113, 140}, {114, 111, 158}, {119, 119, 186}, {128, 130, 181}, {200, 199, 224}, {246, 242, 251}, {255, 242, 247}, {255, 236, 235}, {221, 191, 183}, {184, 148, 130}, {175, 152, 123}, {181, 182, 158}, {207, 215, 208}, {242, 236, 242}, {246, 233, 245}, {213, 202, 229}, {158, 151, 211}, {99, 97, 177}, {70, 71, 139}, {91, 85, 139}, {107, 97, 120}, {94, 89, 87}, {79, 79, 74}, {74, 74, 68}, {68, 69, 65}, {66, 67, 66}},
    	    {{86, 84, 83}, {82, 80, 80}, {84, 88, 89}, {94, 105, 131}, {119, 129, 182}, {89, 97, 160}, {88, 86, 155}, {162, 147, 194}, {235, 226, 241}, {255, 250, 254}, {255, 252, 250}, {246, 215, 211}, {206, 155, 151}, {197, 143, 140}, {190, 165, 164}, {156, 188, 187}, {167, 213, 209}, {223, 232, 229}, {253, 237, 242}, {250, 225, 245}, {209, 184, 231}, {120, 120, 187}, {68, 81, 148}, {89, 81, 143}, {115, 91, 125}, {104, 90, 100}, {85, 81, 83}, {78, 77, 73}, {75, 78, 76}, {78, 80, 80}},
    	    {{80, 78, 78}, {86, 85, 86}, {91, 90, 92}, {118, 116, 156}, {105, 109, 188}, {63, 75, 154}, {136, 135, 207}, {231, 218, 247}, {255, 248, 255}, {255, 251, 250}, {254, 246, 237}, {215, 204, 196}, {194, 173, 173}, {228, 203, 214}, {225, 207, 233}, {160, 163, 185}, {159, 168, 167}, {226, 215, 205}, {255, 234, 231}, {255, 237, 243}, {233, 218, 244}, {164, 149, 204}, {106, 98, 165}, {103, 98, 168}, {99, 97, 142}, {90, 89, 111}, {82, 82, 91}, {72, 74, 72}, {69, 74, 73}, {74, 78, 78}},
    	    {{77, 75, 74}, {83, 83, 90}, {99, 91, 108}, {130, 114, 170}, {88, 86, 183}, {73, 89, 178}, {168, 168, 238}, {240, 214, 255}, {255, 246, 255}, {255, 247, 251}, {237, 237, 240}, {184, 201, 207}, {188, 196, 209}, {235, 215, 236}, {255, 232, 252}, {244, 225, 244}, {221, 194, 215}, {223, 189, 208}, {248, 216, 239}, {251, 231, 255}, {245, 223, 255}, {228, 197, 244}, {156, 126, 203}, {74, 71, 159}, {65, 82, 152}, {98, 109, 160}, {87, 93, 119}, {66, 72, 75}, {67, 74, 73}, {74, 79, 73}},
    	    {{71, 74, 71}, {72, 81, 95}, {94, 97, 129}, {116, 113, 186}, {79, 79, 195}, {101, 106, 206}, {165, 163, 235}, {237, 223, 252}, {249, 236, 251}, {241, 233, 248}, {217, 216, 232}, {184, 193, 214}, {185, 190, 217}, {208, 199, 231}, {210, 196, 231}, {193, 182, 221}, {181, 170, 213}, {173, 158, 208}, {163, 148, 205}, {145, 135, 194}, {135, 127, 181}, {138, 126, 186}, {100, 89, 176}, {64, 70, 176}, {41, 59, 154}, {78, 86, 166}, {106, 106, 149}, {74, 76, 84}, {73, 76, 73}, {92, 93, 80}},
    	    {{66, 74, 69}, {83, 101, 117}, {114, 128, 168}, {91, 101, 178}, {68, 70, 186}, {89, 85, 196}, {136, 131, 230}, {135, 133, 218}, {121, 120, 191}, {110, 109, 176}, {100, 100, 167}, {90, 91, 159}, {81, 83, 152}, {76, 78, 147}, {71, 74, 144}, {67, 70, 139}, {63, 67, 133}, {60, 64, 130}, {59, 63, 132}, {58, 62, 129}, {57, 61, 117}, {56, 61, 112}, {54, 62, 123}, {52, 67, 135}, {62, 82, 150}, {74, 80, 143}, {104, 99, 131}, {81, 79, 82}, {76, 76, 76}, {110, 107, 105}},
    	    {{112, 109, 101}, {108, 109, 129}, {126, 132, 180}, {63, 74, 157}, {60, 65, 183}, {67, 64, 189}, {69, 65, 191}, {71, 67, 191}, {73, 68, 190}, {77, 71, 191}, {78, 72, 190}, {78, 72, 187}, {78, 74, 184}, {79, 77, 185}, {83, 82, 188}, {91, 88, 188}, {101, 95, 184}, {113, 102, 186}, {111, 102, 185}, {100, 100, 177}, {107, 114, 172}, {109, 114, 157}, {110, 115, 149}, {105, 114, 143}, {97, 106, 146}, {76, 78, 124}, {96, 93, 114}, {74, 74, 72}, {71, 74, 77}, {95, 95, 104}},
    	    {{158, 144, 140}, {158, 142, 157}, {140, 138, 173}, {112, 125, 177}, {104, 111, 180}, {114, 113, 179}, {121, 118, 176}, {130, 124, 179}, {139, 130, 184}, {147, 135, 196}, {154, 140, 211}, {158, 143, 223}, {157, 146, 236}, {150, 145, 241}, {147, 142, 241}, {155, 145, 240}, {171, 154, 237}, {178, 152, 226}, {158, 134, 205}, {121, 118, 177}, {92, 101, 138}, {80, 85, 105}, {78, 80, 97}, {76, 77, 91}, {74, 75, 96}, {75, 74, 98}, {74, 71, 82}, {68, 69, 69}, {66, 72, 74}, {74, 76, 80}},
    	    {{189, 174, 174}, {191, 175, 185}, {175, 159, 180}, {187, 170, 191}, {140, 120, 141}, {142, 118, 125}, {134, 115, 106}, {123, 109, 97}, {127, 110, 97}, {138, 114, 116}, {133, 116, 139}, {121, 116, 162}, {104, 104, 173}, {85, 85, 168}, {78, 77, 168}, {82, 78, 167}, {94, 88, 166}, {117, 109, 176}, {123, 115, 172}, {112, 104, 146}, {106, 101, 118}, {91, 94, 94}, {81, 89, 89}, {82, 87, 87}, {83, 85, 87}, {77, 77, 81}, {72, 70, 73}, {71, 71, 73}, {68, 71, 72}, {72, 74, 74}},
    	    {{200, 184, 182}, {196, 180, 187}, {208, 176, 192}, {196, 148, 155}, {166, 118, 117}, {150, 104, 95}, {129, 94, 78}, {117, 94, 95}, {115, 90, 116}, {126, 91, 131}, {107, 87, 136}, {72, 77, 136}, {58, 69, 137}, {65, 69, 138}, {75, 76, 140}, {75, 76, 138}, {67, 70, 133}, {58, 68, 134}, {65, 72, 143}, {91, 78, 145}, {115, 95, 143}, {114, 115, 143}, {86, 101, 111}, {80, 88, 87}, {78, 82, 81}, {74, 76, 76}, {75, 75, 75}, {74, 74, 74}, {70, 71, 71}, {74, 77, 77}},
    	    {{180, 180, 176}, {170, 175, 178}, {166, 157, 166}, {194, 168, 162}, {161, 124, 101}, {145, 98, 73}, {140, 95, 70}, {136, 96, 110}, {113, 86, 150}, {84, 74, 151}, {94, 90, 166}, {101, 97, 170}, {131, 125, 192}, {182, 176, 231}, {205, 198, 236}, {204, 196, 231}, {184, 174, 222}, {142, 128, 193}, {107, 94, 180}, {81, 77, 171}, {74, 74, 152}, {100, 95, 153}, {108, 101, 123}, {90, 89, 85}, {77, 80, 76}, {77, 79, 76}, {77, 79, 77}, {73, 75, 73}, {68, 71, 71}, {70, 74, 75}},
    	    {{111, 128, 143}, {112, 140, 151}, {92, 104, 110}, {154, 150, 140}, {150, 125, 98}, {146, 99, 79}, {152, 98, 89}, {148, 90, 120}, {107, 79, 156}, {72, 85, 167}, {98, 108, 178}, {167, 153, 207}, {228, 206, 241}, {252, 234, 255}, {255, 245, 255}, {254, 243, 250}, {253, 228, 233}, {241, 203, 219}, {195, 164, 218}, {119, 124, 204}, {67, 87, 170}, {80, 70, 144}, {112, 84, 119}, {104, 92, 97}, {81, 83, 83}, {81, 83, 80}, {81, 84, 82}, {72, 76, 76}, {72, 77, 79}, {82, 87, 90}},
    	    {{126, 163, 197}, {79, 110, 128}, {74, 89, 90}, {138, 136, 122}, {149, 127, 96}, {142, 99, 85}, {144, 105, 112}, {131, 100, 146}, {97, 82, 173}, {96, 98, 185}, {124, 130, 193}, {160, 164, 201}, {169, 175, 184}, {182, 195, 196}, {205, 219, 225}, {201, 210, 205}, {194, 190, 153}, {186, 157, 126}, {157, 123, 145}, {140, 126, 191}, {114, 113, 200}, {84, 78, 169}, {95, 86, 135}, {103, 100, 115}, {89, 89, 93}, {95, 96, 92}, {87, 90, 88}, {76, 79, 81}, {79, 83, 86}, {81, 86, 91}},
    	    {{142, 199, 218}, {90, 123, 133}, {60, 78, 79}, {129, 131, 116}, {147, 130, 100}, {143, 106, 99}, {138, 114, 137}, {94, 89, 145}, {81, 78, 166}, {141, 132, 200}, {155, 156, 184}, {124, 144, 160}, {92, 126, 146}, {96, 141, 164}, {135, 180, 205}, {151, 186, 203}, {146, 160, 157}, {157, 137, 132}, {156, 117, 136}, {155, 123, 166}, {158, 135, 205}, {86, 84, 166}, {70, 82, 144}, {105, 110, 151}, {101, 100, 116}, {109, 110, 105}, {93, 95, 92}, {80, 82, 81}, {81, 83, 83}, {86, 91, 92}},
    	    {{128, 175, 180}, {99, 133, 136}, {73, 89, 90}, {131, 128, 114}, {164, 142, 110}, {156, 114, 114}, {140, 114, 154}, {81, 77, 142}, {94, 92, 177}, {182, 173, 223}, {205, 197, 189}, {186, 183, 177}, {152, 160, 190}, {108, 132, 177}, {91, 115, 160}, {98, 110, 150}, {138, 135, 165}, {206, 184, 206}, {200, 170, 185}, {159, 137, 159}, {180, 166, 218}, {109, 107, 180}, {64, 69, 144}, {89, 90, 159}, {108, 106, 135}, {102, 102, 97}, {91, 92, 88}, {84, 85, 82}, {85, 85, 83}, {96, 98, 96}},
    	    {{114, 151, 150}, {95, 131, 132}, {85, 100, 103}, {131, 123, 117}, {180, 153, 134}, {170, 125, 135}, {144, 116, 165}, {80, 77, 140}, {112, 111, 181}, {200, 190, 234}, {243, 225, 228}, {243, 216, 211}, {216, 198, 203}, {156, 159, 172}, {154, 159, 177}, {158, 147, 168}, {168, 147, 166}, {224, 201, 218}, {198, 177, 189}, {151, 139, 157}, {178, 173, 215}, {135, 133, 194}, {71, 70, 139}, {94, 92, 159}, {110, 107, 135}, {97, 96, 92}, {90, 91, 88}, {88, 88, 85}, {86, 85, 83}, {92, 92, 90}},
    	    {{115, 132, 124}, {113, 129, 128}, {109, 113, 119}, {132, 124, 124}, {143, 131, 124}, {142, 127, 149}, {129, 121, 179}, {77, 78, 140}, {127, 124, 182}, {217, 205, 239}, {245, 226, 237}, {242, 216, 211}, {203, 177, 158}, {172, 151, 132}, {190, 174, 165}, {170, 156, 157}, {156, 138, 146}, {219, 191, 203}, {209, 183, 192}, {147, 138, 152}, {163, 166, 199}, {126, 127, 177}, {72, 71, 135}, {96, 95, 160}, {110, 107, 135}, {90, 91, 88}, {86, 90, 87}, {84, 88, 85}, {83, 87, 84}, {90, 94, 91}},
    	    {{116, 114, 108}, {110, 106, 104}, {105, 100, 100}, {109, 102, 102}, {103, 105, 104}, {116, 130, 156}, {116, 127, 188}, {77, 82, 154}, {103, 100, 175}, {192, 179, 234}, {237, 217, 244}, {204, 178, 186}, {165, 131, 127}, {186, 142, 134}, {225, 187, 180}, {191, 173, 166}, {159, 143, 137}, {200, 163, 158}, {191, 154, 149}, {147, 141, 147}, {157, 170, 208}, {116, 122, 185}, {70, 71, 140}, {98, 97, 162}, {104, 102, 132}, {84, 87, 86}, {83, 90, 89}, {81, 89, 86}, {84, 93, 90}, {88, 97, 94}},
    	    {{149, 140, 136}, {153, 142, 138}, {153, 142, 138}, {154, 143, 142}, {139, 137, 140}, {134, 143, 174}, {110, 116, 181}, {80, 81, 164}, {86, 83, 179}, {162, 157, 232}, {161, 157, 198}, {111, 110, 131}, {118, 111, 121}, {163, 144, 145}, {191, 173, 165}, {174, 170, 155}, {151, 148, 127}, {150, 136, 113}, {160, 139, 119}, {184, 169, 167}, {172, 163, 209}, {92, 94, 172}, {59, 67, 143}, {83, 86, 153}, {100, 100, 131}, {87, 89, 91}, {85, 90, 90}, {87, 93, 90}, {89, 96, 93}, {90, 97, 94}},
    	    {{196, 179, 175}, {195, 177, 173}, {192, 176, 171}, {186, 172, 165}, {172, 168, 159}, {136, 141, 147}, {132, 134, 160}, {111, 108, 163}, {76, 75, 163}, {98, 100, 180}, {139, 150, 205}, {130, 153, 187}, {110, 129, 144}, {125, 130, 133}, {147, 150, 146}, {167, 176, 167}, {184, 195, 184}, {193, 200, 195}, {213, 208, 220}, {214, 188, 221}, {149, 118, 178}, {74, 73, 147}, {75, 93, 148}, {107, 115, 151}, {92, 93, 111}, {90, 92, 94}, {88, 91, 91}, {85, 89, 87}, {86, 91, 90}, {88, 93, 93}},
    	    {{194, 181, 177}, {190, 178, 173}, {187, 177, 171}, {186, 177, 165}, {172, 170, 150}, {127, 135, 117}, {114, 122, 108}, {119, 125, 154}, {91, 100, 181}, {63, 76, 161}, {95, 114, 183}, {153, 178, 225}, {197, 212, 232}, {232, 226, 231}, {244, 234, 232}, {235, 234, 231}, {234, 233, 232}, {243, 230, 241}, {221, 202, 244}, {150, 138, 206}, {104, 96, 172}, {108, 100, 171}, {111, 104, 137}, {101, 98, 104}, {86, 85, 90}, {92, 91, 94}, {97, 95, 96}, {87, 87, 85}, {82, 85, 85}, {81, 85, 88}},
    	    {{189, 180, 191}, {181, 174, 173}, {175, 169, 155}, {174, 170, 152}, {168, 171, 151}, {127, 138, 116}, {98, 112, 88}, {94, 109, 118}, {93, 112, 162}, {75, 98, 165}, {50, 77, 152}, {80, 109, 181}, {154, 166, 228}, {218, 200, 246}, {244, 219, 246}, {240, 230, 250}, {243, 232, 255}, {243, 211, 245}, {193, 160, 216}, {116, 117, 181}, {83, 97, 160}, {106, 92, 145}, {119, 87, 113}, {100, 84, 88}, {88, 84, 86}, {98, 93, 93}, {94, 88, 87}, {87, 85, 83}, {80, 81, 79}, {82, 85, 83}},
    	    {{89, 124, 150}, {99, 125, 126}, {103, 124, 100}, {82, 99, 76}, {139, 153, 133}, {128, 138, 113}, {100, 114, 81}, {71, 90, 78}, {74, 97, 115}, {90, 115, 164}, {82, 102, 183}, {63, 75, 172}, {72, 75, 179}, {100, 92, 181}, {137, 127, 183}, {132, 131, 178}, {122, 120, 185}, {160, 147, 220}, {168, 151, 218}, {131, 122, 182}, {106, 101, 150}, {103, 90, 128}, {98, 82, 101}, {88, 79, 83}, {86, 83, 82}, {96, 92, 88}, {86, 81, 78}, {82, 79, 76}, {78, 77, 72}, {79, 81, 73}},
    	    {{127, 207, 245}, {87, 146, 159}, {36, 84, 71}, {73, 113, 96}, {124, 149, 131}, {128, 139, 113}, {103, 117, 82}, {77, 99, 74}, {86, 112, 103}, {98, 124, 133}, {118, 132, 159}, {116, 111, 156}, {93, 85, 150}, {77, 77, 144}, {71, 77, 131}, {70, 79, 126}, {74, 83, 130}, {89, 96, 140}, {122, 121, 160}, {148, 129, 163}, {138, 112, 139}, {112, 100, 120}, {84, 83, 94}, {78, 77, 80}, {87, 84, 84}, {97, 93, 89}, {85, 80, 78}, {87, 83, 82}, {81, 78, 74}, {84, 85, 78}},
    	    {{111, 179, 229}, {127, 174, 198}, {64, 101, 97}, {53, 81, 70}, {123, 140, 125}, {134, 140, 114}, {108, 122, 85}, {84, 111, 72}, {83, 112, 76}, {90, 118, 86}, {103, 123, 95}, {118, 127, 121}, {110, 116, 141}, {115, 122, 166}, {112, 119, 172}, {106, 113, 161}, {119, 124, 152}, {125, 129, 143}, {133, 131, 142}, {143, 128, 136}, {140, 120, 124}, {115, 102, 103}, {92, 86, 88}, {80, 76, 78}, {83, 81, 80}, {88, 87, 83}, {79, 78, 76}, {79, 79, 79}, {80, 80, 77}, {82, 84, 78}},
    	    {{76, 132, 157}, {86, 122, 131}, {85, 111, 105}, {78, 95, 89}, {131, 140, 135}, {147, 148, 132}, {115, 129, 100}, {97, 129, 99}, {93, 126, 100}, {96, 126, 102}, {101, 127, 108}, {107, 130, 122}, {114, 133, 141}, {119, 133, 151}, {123, 132, 156}, {125, 130, 151}, {124, 127, 137}, {128, 129, 134}, {141, 139, 146}, {147, 137, 143}, {131, 115, 119}, {116, 102, 103}, {100, 87, 88}, {84, 76, 76}, {80, 75, 75}, {81, 82, 80}, {78, 82, 81}, {78, 82, 82}, {79, 83, 82}, {80, 84, 81}},
    	    {{111, 136, 137}, {113, 127, 125}, {105, 116, 108}, {100, 108, 106}, {126, 129, 133}, {156, 155, 149}, {153, 157, 136}, {140, 153, 132}, {136, 149, 131}, {134, 146, 132}, {130, 142, 131}, {124, 139, 129}, {121, 135, 126}, {121, 133, 125}, {131, 136, 130}, {139, 134, 128}, {127, 121, 114}, {110, 111, 107}, {107, 110, 113}, {117, 111, 117}, {121, 110, 115}, {118, 106, 110}, {111, 100, 100}, {87, 80, 79}, {74, 71, 71}, {74, 75, 75}, {75, 79, 79}, {74, 78, 77}, {74, 79, 79}, {87, 91, 91}},
    	    {{139, 134, 133}, {132, 127, 123}, {125, 122, 113}, {119, 117, 115}, {117, 114, 118}, {116, 112, 112}, {114, 109, 106}, {113, 108, 101}, {111, 106, 97}, {109, 104, 97}, {104, 103, 99}, {100, 105, 100}, {85, 94, 86}, {87, 97, 89}, {126, 129, 121}, {155, 140, 133}, {133, 117, 110}, {102, 103, 99}, {110, 118, 123}, {136, 134, 144}, {135, 128, 135}, {115, 106, 112}, {106, 97, 101}, {91, 86, 89}, {75, 72, 74}, {74, 75, 76}, {81, 85, 86}, {89, 94, 94}, {91, 98, 97}, {99, 103, 99}},
    	    {{99, 95, 91}, {103, 98, 91}, {90, 86, 75}, {77, 74, 69}, {76, 74, 76}, {77, 76, 83}, {83, 80, 92}, {92, 86, 93}, {95, 90, 91}, {97, 94, 93}, {92, 89, 90}, {82, 80, 79}, {80, 80, 73}, {81, 84, 75}, {118, 115, 106}, {157, 140, 131}, {136, 118, 109}, {104, 102, 98}, {115, 120, 128}, {144, 146, 160}, {146, 145, 155}, {110, 106, 113}, {101, 94, 101}, {88, 84, 90}, {78, 74, 79}, {74, 75, 79}, {88, 91, 94}, {96, 102, 104}, {104, 113, 109}, {98, 104, 96}},
    	    {{87, 84, 85}, {106, 100, 95}, {81, 76, 64}, {76, 71, 65}, {70, 68, 68}, {76, 77, 80}, {90, 88, 96}, {96, 88, 92}, {90, 84, 84}, {91, 88, 87}, {100, 95, 96}, {97, 88, 88}, {89, 81, 78}, {86, 82, 77}, {120, 112, 105}, {158, 138, 130}, {138, 119, 109}, {105, 100, 91}, {117, 121, 118}, {143, 149, 149}, {137, 142, 142}, {106, 105, 107}, {99, 94, 99}, {96, 91, 98}, {84, 80, 84}, {73, 72, 74}, {79, 83, 83}, {95, 102, 102}, {90, 102, 99}, {89, 97, 90}}
    	};
    // Push matrix A and B into AXI streams
    for (int i = 0; i < img_h; i++) {
        for (int j = 0; j < img_w; j++) {
            for (int k = 0; k < img_d; k++) {
            	image_in.write(float_to_axi(image[i][j][k]));
            }
        }
    }

    // Call the matrix multiplication function (this will process the data)
    cnn(image_in, predict_class);

    //float result[m_out_h][m_out_w][m_out_d];
    float result_probablity, result_class;

/*
    for (int k = 0; k < m_out_d; k++) {
    	for (int i = 0; i < m_out_h; i++) {
    		for (int j = 0; j < m_out_w; j++) {
            AXI_VAL temp = image_out.read();
            result[i][j][k] = axi_to_float(temp);
        	}
        }
    }
*/

    	AXI_VAL tempa = predict_class.read();
    	result_class = axi_to_float(tempa);

/*
    for (int k = 0; k < m_out_d; k++) {
    	for (int i = 0; i < m_out_h; i++) {
        	cout<<"{";
            for (int j = 0; j < m_out_w; j++){
            		cout<<result[i][j][k]<<" ";
            	}
            	cout<<"}"<<endl;
            }
            cout<<endl;
        }

*/
    	cout<<endl;
    	cout<<"Prediction: Class ID ("<<result_class<<")"<<endl;
    	cout<<endl;
    return 0;
}
